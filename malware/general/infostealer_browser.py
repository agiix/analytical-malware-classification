
name = "infostealer_browser"
description = "Steals private information from local Internet browsers"
categories = ["infostealer"]
ttp = ["T1081", "T1003", "T1005"]
indicators = []

old_paths = [
        "\\Mozilla\\Firefox\\Profiles\\.*\\.default\\signons\\.sqlite$",
        "\\Mozilla\\Firefox\\Profiles\\.*\\.default\\secmod\\.db$",
        "\\Mozilla\\Firefox\\Profiles\\.*\\.default\\cert8\\.db$",
        "\\Mozilla\\Firefox\\Profiles\\.default\\key3\\.db$",
        "\\(Application\\ Data|AppData).*?\\Google\\Chrome\\.*",
        "\\(Application\\ Data|AppData).*?\\Opera\\.*",
        "\\(Application\\ Data|AppData).*?\\Chromium\\.*",
        "\\(Application\\ Data|AppData).*?\\ChromePlus\\.*",
        "\\(Application\\ Data|AppData).*?\\Nichrome\\.*",
        "\\(Application\\ Data|AppData).*?\\Bromium\\.*",
        "\\(Application\\ Data|AppData).*?\\RockMelt\\.*",
        "\\(Application\\ Data|AppData).*?\\Yandex\\YandexBrowser\\.*",
    ]

    
firefox_paths = [
        # Profile Directory, subdirectory with the actual profile name can vary
        "\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles",
        "\\Mozilla\\Firefox\\Profiles\\"
]

chrome_paths = [
    "AppData\\Local\\Google\\Chrome\\User"
]

microsoft_edge_paths = [
    "AppData\\Local\\Microsoft\\Edge\\User Data"
]

"""
bookmarkbackups: Subfolder that contains bookmarkbackups
key4,logins.json: Stores passwords
places.sqlite: Contains all Firefox bookmarks and lists of all the files downloaded and websites visited 
permissions.sqlite, Content-prefs.sqlite: Stores Firefox permissions
search.json.mozlz4: Stores user-installed search engines
persdict.dat: Stores any custom words added to Firefox's dictionary
formhistory.sqlite: Saves search history and entered forms data
cookies.sqlite: Stores cookies
webappsstore.sqlite: Alternative (more secure way) to store cookies
extensions: Subfolder that contains all installed extensions
cert9: Stores security certs
pkcs11: Stores security module configuration
handlers.json: Stores Firefox preferences
sessionstore.jsonlz4: Stores currently open tabs and windows
xulstore.json: Stores toolbar and window size/position settings
prefs.js,user.js: Stores customized user preference settings
"""    
firefox_files = [
        "bookmarkbackups",
        "key4",
        "logins.json",
        "places.sqlite",
        "permissions.sqlite",
        "content-prefs.sqlite",
        "search.json.mozlz4",
        "persdict.dat",
        "formhistory.sqlite",
        "cookies.sqlite",
        "webappsstore.sqlite",
        "extensions",
        "cert9",
        "pkc11",
        "handlers.json",
        "sessionstore.jsonlz4",
        "xulstore.json",
        "prefs.js",
        "user.js",
        #old ones starting here
        "scmod",
        "cert8",
        "key3",
]

chrome_files = [
    "History",
    "Cookies",
    "Bookmarks",
    "Current Session",
    "Current Tabs",
    "CURRENT",
    "DownloadMetadata",
    "Web Data",
    "Top Sites",
    "Shorcuts",
    "Secure Preferences",
    "Preferences",
    "Login Data",
    "Last Session",
    "Last Tabs",
    "Cache"
]

edge_files = [
    "Login Data"
]

regkeys_re = [
        "\\Software\\Mozilla\\SeaMonkey",
        "\\Software\\Opera\\ Software",
        "\\Software\\Mozilla\\Mozilla\\ Firefox",
    ]

regkeys_new = [
        #Firefox
        "HKEY_CLASSES_ROOT\\Applications\\Firefox",
        "HKEY_CURRENT_USER\\Software\\Classes\\Applications\\Firefox",
        "HKEY_CURRENT_USER\\Software\\Clients\\StartMenuInternet\\Firefox",
        "HKEY_CURRENT_USER\\Software\\Mozilla\\Firefox",
        "HKEY_CURRENT_USER\\Software\\Mozilla\\Mozilla Firefox",
        #Chrome
        "HKEY_CURRENT_USER\\Software\\Clients\\StartMenuInternet\\Google Chrome",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\Google\\Chrome",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\chrome.exe",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\RegisteredApplications",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Clients\\StartMenuInternet\\Google Chrome",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Google",
        "HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\App Paths\\chrome.exe"
        "HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\\EventLog\\Applications\\Chrome"
    ]

#Expects a json line of kind type file
def checkfile(line):
    for path in firefox_paths:
        if path in line.get('event', {}).get('srcpath'):
            for f in firefox_files:
                if f in line.get('event', {}).get('srcpath'):
                    indicators.append(f)
    for path in chrome_paths:
        if path in line.get('event', {}).get('srcpath'):
            for f in chrome_files:
                if f in line.get('event', {}).get('srcpath'):
                    indicators.append(f)

#Expects a json line of kind type registry
def checkreg(line):
    for reg in regkeys_new:
        if reg in line.get('event', {}).get('path'):
            indicators.append(reg)


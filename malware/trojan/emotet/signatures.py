#!/usr/bin/env python3


"""
---------------------------------------------------------------------------
            SIGNATURES INDICATING EMOTET BEHAVIOR
---------------------------------------------------------------------------
"""

#MITRE TAG = T1060
"""Emotet queries a Windows value called GettickCount which then queries
'\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\BITS\\Performance' to 
obtain information on how much time has elapsed since the system started, or 
since the Emotet payload launched, as a sort of sanity check. It may use this 
to determine whether it is running in a sandbox, because some sandbox software 
may skip ticks in order to trigger malware that runs with a built-in, timed 
delay before beginning operation.
It additionally queries and sets an int value to a registry key named 
'TaskExecutionCountSinceLastReset', which might seems to be a EMOTET specific
named registry key. 
There is a pattern of queries, which involves exactly 7 different Performance
registry keys as well as the check for TaskExecutionCountSinceLastReset at 
some later point
"""

regperformance = "\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\BITS\\Performance"
regkeywordcount = "TaskExecutionCountSinceLastReset"
regperformancecount = 0
regperformancethreshold = 7
regkeywordset = False
def performanceregistry(line):    
    if line.get('event', {}).get('kind') == "QueryValueKey": 
        if regperformance in line.get('event', {}).get('path'):
            regperformancecount+=1
    if line.get('event', {}).get('kind') == "CreateKeyEx":
        if regperformance in line.get('event', {}).get('path'):
            regperformancecount+=1
    if line.get('event', {}).get('kind') == "SetValueKeyStr":
        if regperformance in line.get('event', {}).get('path'):
            regperformancecount+=1
    if line.get('event', {}).get('kind') == "SetValueKeyInt":
        if regkeywordcount in line.get('event', {}).get('path'):
            regkeywordset = True
    if regkeywordcount > 6 and regkeywordset:
        return True



#MITRE TAG = T1047
"""Uses WMI to stealthy execute powershell.exe 
"""

def checkwmiprvse(line):
    if line.get('event', {}).get('command') == "C:\\Windows\\system32\\wbem\\wmiprvse.exe -secured -Embedding":
        return True


#MITRE TAG = T1032
"""Emotet is known to use RSA keys for encrypting C2 traffic.
Therefore queries to the following reg key can be observed. 
"""

regRSA = "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Defaults\\Provider\\Microsoft Enhanced RSA and AES Cryptographic Provider"
def rsaregistry(line):    
    if line.get('event', {}).get('kind') == "QueryValueKey": 
        if regRSA in line.get('event', {}).get('path'):
            return True



# Emotet

## Infection
- Infection by specially crafted spam. these spam messages always change, to 'personalize' some details
- Victims are either asked to open a attached malicious document or download it from a provided link.
- The Emotet malware is constantly changing, new versions were detected on a day to day basis, but the killchain always starts by providing a malicious file attachment (usually a Microsoft Office document).
- The malicious document templates are designed to encourage the victim to turn off macro script-blocking features within Office.
- After launching the document and enabling macro scripts, the infection occurs by executing several obfuscated command lines in the background until it invokes a PowerShell command that downloads an Emotet executable.

## First Stage
- The first command uses three completely bogus directories and a directory traversal gimmick that navigates the script back to the root of the hard drive, then up the correct folder path to system32, to invoke cmd.exe, again. That second command further decodes parts of the obfuscation and launches a third command, which in turn executes a PowerShell command.
- Research has shown that, no more than four such child processes were launched in the course of the attack, and the attack sometimes took up to a minute to complete as the final script tried to download a payload from each of the hardcoded payload URLs embedded within the final-stage PowerShell script, in sequence.
- The payload URLs all follow a similar pattern in their construction: they have been hosted on the root level of a legitimate, but previously compromised, website. The filenames are from three to (usually a maximum of) 12 randomised alphanumeric characters in length. In a handful of instances, the mail messages did not use Office documents but had attached PDF documents instead. In these cases, the PDF linked to a maldoc file and, in at least a few cases, directly downloaded the Emotet executable payload without resorting to the full series of commands and PowerShell script.
- Emotet makes copies of itself into fixed, standard locations on the Windows filesystem, generating filenames based on values unique to the system and a table of name fragments it pulls from itself, and generates a mutex for itself that follows a predictable pattern.
- The main goals of Emotet are to gain persistence on the infected machine, collect a wide range of information about the victim from the machine and then download payload modules from the C2 designed specifically to take greatest advantage of the victim’s profile or device. Additionally it's using techniques that also seek to subvert the work of reverse engineers or analysts.
- The malware has been packed by its own, quite sophisticated packer, which itself has been packed in multiple layers of obfuscation.
- Emotet runs several junk functions, or subroutines that serve no purpose other than to misdirect an analyst and uses junk strings to complicate the analysis further.
- The malware may use these embedded, random-looking text strings to determine whether it has been tampered with. The malware compares those strings to values stored in memory. If they don’t match, the malware quits. If they do, it goes on to create new events and mutexes and continues to run.
- Upon initial execution, the Emotet executable makes a copy of itself from the %temp% directory (where the PowerShell script normally saves it to the victim’s hard drive) in a standard Windows location, such as the C:\ Windows\SysWOW64 directory, and creates a mutex that starts with the letter M and is followed by a string hash value.
- It also creates events that start with the letter E followed by a string hash value. The string values in the mutex and event names are made up of the current process identifier value (PID) and its child PID.
- The malware always unpacks two instances of itself into memory while the setup phase is ongoing, with one instance watching the other’s back. When the malware has finished its initial setup, it sends a signal that closes both processes, but not before injecting itself into the memory space of other running system applications (such as svchost.exe). When setup is complete, the malware deletes itself from the hard drive.
- After this initial setup, the behaviour of the processes is also determined by the mutexes and events. Emotet uses these to check whether a child process (such as a plugin) is running as a result of being launched by the malware’s process.
- Emotet will look for the presence of the mutex when it first starts up to prevent multiple copies from running on the infected computer. However, it also sets up a process by which it periodically queries for the mutex and, if it doesn’t find it, will use that to restart the initial malware executable.
- In some cases, it also creates global mutexes and events from the file system and generates the mutex and event names using the information it can glean from the volume serial number information (specifically, the lpVolumeSerialNumber argument from the GetVolumeInformationW function call).
- Emotet also uses Scheduled Tasks and other more conventional methods to trigger itself to run after the host computer powers off or reboots. It’s also known to set up a Windows service that will keep the main Emotet executable alive.

## Sandbox Detection & Anti-debugging:
- Emotet queries a Windows value called GettickCount any time it calls an important function. This GettickCount behaviour looks like the malware is checking how much time has elapsed since the system started, or since the Emotet payload launched, as a sort of sanity check. It may use this to determine whether it is running in a sandbox, because some sandbox software may skip ticks in order to trigger malware that runs with a built-in, timed delay before beginning operation.
- The malware generates hash values for all the currently running processes, then performs a hash comparison against them to determine if debugger or analysis tools are also running on the infected system.

## C&C
- The malware creates a hidden program window in order to run malicious code periodically. It does this in order to perform routine tasks, including sending information and receiving information from the command and control (C2) server. The Emotet family could not do what it does without receiving a constant stream of instructions from its owners. Nor could it work in the absence of the detailed level of feedback about its operating environment that each bot sends home from an infected host machine. 
- Emotet relies on the bot being able to send and receive regular instalments of data and feedback, instructions and results, payloads and signals about task completion. If the bot cannot connect, it cannot do its job.
- Emotet tends to rely on the use of compromised, legitimate websites for hosting the malware itself, but it uses servers under the direct control of the botnet operators to receive messages from, and send instructions to, each node on the botnet

## C2 Communication and HTTP Usage
- It typically uses the HTTP protocol to exfiltrate stolen data or receive instructions, but it does not strictly follow the conventions of that protocol, nor does it transmit that information in the clear.
- The malware encrypts all the data it will transmit using a two-stage process, which it then transmits over unencrypted HTTP. It performs these communications with its C2 servers by performing an HTTP GET request that includes the passing of the data in the guise of a browser cookie. The server may respond with a simple acknowledgment or with a longer set of instructions or commands.
- Emotet gathers some information about the infected system and then serialises that data using **protobuf**, before compressing with zlib.
- Then it encrypts the message. The Emotet binary contains an RSA public key, which it uses with the CryptGenKey function call to generate an AES 128 symmetric encryption key pair.
- Emotet encrypts the data block using this key, then encodes the encrypted data in base64, and finally transmits it by performing an HTTP GET request to the root directory of the C2 server.
- It transmits the data by attaching it as a cookie to the HTTP request headers, thereby making the content of the HTTP request empty.
- The C2 servers can receive these communications on port 80 but may also receive them on port 443, or on several other non-standard ports, including but not limited to 7080, 8080, 8090, 50000 or several others.
- The response from the C2 server contains an encrypted blob of feedback, which the malware needs to decrypt and verify before it will act upon the instructions.

## Payload & Plugins
- The malware uses a series of plugins that can extend its functionality, many of which are designed to steal user information from the infected device and help the malware move laterally within the network hosting the infected computer.
- Some of Emotet’s own payloads are freeware tools that have been wrapped up in the malware’s encryption and delivered to the victim’s computer. Notably, Emotet has used the otherwise benign NirSoft freeware tools Network Password Recovery and WebBrowserPassView to extract saved network and website passwords.
- One plugin harvests the contact list from Outlook and then sends out versions of the original spam used to infect the first victim’s computer to the people that the victim has emailed in the past. The email harvesting module uses the Windows Mail API (MAPI) to collect the email addresses from Outlook.
- The mail scraper component saves the email addresses to a randomly named .tmp file. When scraping for addresses is complete, the tool passes this file to the spam module as a parameter. The spam module uses that .tmp to build the spam emails on the fly, with a PDF attachment that contains a link to an Emotet installer. The messages look essentially identical to the messages used in the initial attack.
- One of Emotet’s most potentially dangerous plugins is called Credential Enumerator. The malware uses this plugin to find Windows (SMB) file shares that are writable by the user account under which the malware is running, or it may try to brute-force the password to shares that it finds that it cannot write to. Once it finds a writable share, the component copies itself, then Emotet, to the new share. 

- Emotet’s main process performs these following steps:
1. It sets the autorun registry keys and establishes persistence on the infected machine.
2. It dynamically loads its DLL payloads; communicates with its C2.
3.  It creates temporary files to store the passwords and other data it has stolen. 
4. Finally, it creates processes with the CREATE_SUSPENDED flag set in order to inject itself using WriteProcessMemory.
The main Emotet executable creates these processes, injects itself into the process memory and uses the ResumeThread API function to launch them.



## Emotet Classification 
[See MITRE](https://attack.mitre.org/software/S0367/)

| ID | Name | Use | 
| :---------     | :----------   | :----------   | 
| T1110 | Brute Force | Emotet has been observed using a hard coded list of passwords to brute force user accounts |
| T1059	| Command-Line Interface | Emotet has used cmd.exe to run a PowerShell script |
| T1043	| Commonly Used Port | Emotet has used ports 20, 22, 80, 443, 8080, and 8443 |
| T1003	| Credential Dumping | Emotet has been observed dropping browser and password grabber modules including Mimikatz |
| T1081	| Credentials in Files | Emotet has been observed leveraging a module that retrieves passwords stored on a system for the current logged-on user |
| T1094	| Custom Command and Control Protocol | Emotet has been observed using an encrypted, modified protobuf-based protocol for command and control messaging |
| T1022	| Data Encrypted | Emotet has been observed encrypting the data it collects before sending it to the C2 server | 
| T1114	| Email Collection | Emotet has been observed leveraging a module that scrapes email data from Outlook | 
| T1041	| Exfiltration Over Command and Control Channel	| Emotet has been seen exfiltrating system information stored within cookies sent within an HTTP GET request back to its C2 servers | 
| T1210	| Exploitation of Remote Services | Emotet has been seen exploiting SMB via a vulnerability exploit like ETERNALBLUE (MS17-010) to achieve lateral movement and propagation |
| T1040	| Network Sniffing | Emotet has been observed to hook network APIs to monitor network traffic | 
| T1050	| New Service | Emotet has been observed creating new services to maintain persistence |
| T1027	| Obfuscated Files or Information | Emotet has obfuscated macros within malicious documents to hide the URLs hosting the malware, CMD.exe arguments, and PowerShell scripts |
| T1086	| PowerShell | Emotet has used Powershell to retrieve the malicious payload and download additional resources like Mimikatz | 
| T1057	| Process Discovery | Emotet has been observed enumerating local processes | 
| T1055	| Process Injection | Emotet has been observed injecting in to Explorer.exe and other processes | 
| T1060	| Registry Run Keys / Startup Folder | Emotet has been observed adding the downloaded payload to the HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run key to maintain persistence | 
| T1053	| Scheduled Task | Emotet has maintained persistence through a scheduled task | 
| T1064	| Scripting | Emotet has sent Microsoft Word documents with embedded macros that will invoke scripts to download additional payloads |
| T1045	| Software Packing | Emotet has used custom packers to protect its payloads | 
| T1193	| Spearphishing Attachment | Emotet has been delivered by phishing emails containing attachments | 
| T1192	| Spearphishing Link | Emotet has been delivered by phishing emails containing links | 
| T1032	| Standard Cryptographic Protocol	| Emotet is known to use RSA keys for encrypting C2 traffic | 
| T1065	| Uncommonly Used Port | Emotet has been observed communicating over non standard ports, including 7080 and 50000 |
| T1204	| User Execution | Emotet has relied upon users clicking on a malicious link or attachment delivered through spearphishing |
| T1077	| Windows Admin Shares | Emotet leverages the Admin$ share for lateral movement once the local admin password has been brute forced |
| T1047	| Windows Management Instrumentation | Emotet has used WMI to execute powershell.exe | 

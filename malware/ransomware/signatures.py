import base64

"""
---------------------------------------------------------------------------
            SIGNATURES INDICATING RANSOMWARE BEHAVIOR
---------------------------------------------------------------------------
"""


"""line would be a parsed entry from the onemon json file.
delshadowcopies expects an entry of the "*onemon.Process" category
and looks for the command key and keywords like 'wmic shadowcopy
delete' or 'vssadmin delete shadows'
Suited for Windows 7 & 10
"""
shadowtoken1 = ["vssadmin","delete","shadows"]
shadowtoken2 = ["wmic","shadowcopy","delete"]
def delshadowcopies(line):
    if all(token in line.get('event', {}).get('command') for token in shadowtoken1):
        return True
    if all(token in line.get('event', {}).get('command') for token in shadowtoken2):
        return True    
    else:
        return False



"""line would be a parsed entry from the onemon json file.
cryptoregistry expects an entry of the "*onemon.Registry" category
and looks for registry queries that check for Microsofts Crptography
library. 
Suited for Windows 7 & 10
"""
def crpytoregistry(line):
    if line.get('event', {}).get('kind') == "QueryValueKey" and "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography" in line.get('event', {}).get('path'):
        return True
    if line.get('event', {}).get('kind') == "OpenKeyEx" and "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography" in line.get('event', {}).get('path'):
        return True
    if line.get('event', {}).get('kind') == "EnumerateKey" and "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography" in line.get('event', {}).get('path'):
        return True
    if line.get('event', {}).get('kind') == "QueryKey" and "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography" in line.get('event', {}).get('path'):
        return True
    else:
        return False



"""
---------------------------------------------------------------------------
            SIGNATURES INDICATING MALWARE BEHAVIOR
---------------------------------------------------------------------------
"""

"""line would be a parsed entry from the onemon json file.
tempexe expects an entry of the "*onemon.Process" category and checks the
command key for executables that launch from temp folders.
Additionally the orig-key will be checked for the value 'False'
Suited for Windows 7 & 10
"""

def tempexe(line):
    if "\\Temp\\" in line.get('event', {}).get('image') and line.get('event', {}).get('orig') == False:
        return True
    else:
        return False





"""
---------------------------------------------------------------------------
                 SIGNATURES NOT SUITED FOR THREEMON
---------------------------------------------------------------------------
"""


"""line would contain a onemon entry of the category "*onemon.FileContents" 
and would be passed to ransomNote for further investigation
ransomwNote checks for "buf", decodes it and looks for certain strings"""

# This matchings are pretty weak, since malware would only need to change
# one character to bypass detection
ransomtokens = (b"encrypted", b"decrypted",
                b"bitcoin", b"decryption", b"encryption")

def ransomNote(line):
    if line.get('event', {}).get('buf') is not None:
        note = base64.b64decode(line.get('event', {}).get('buf'))

        for token in ransomtokens:
            if token in note:
                return True

    return False

event_sigs = {
    "*onemon.FileContents": [ransomNote]
}

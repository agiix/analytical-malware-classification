#!/usr/bin/env python3

import argparse
import json
import os
import pprint
import sys

from malware.ransomware.signatures import event_sigs

whitelist = [
    '*onemon.networklisten', '*onemon.syscallbbb', '*onemon.mutant',
    '*onemon.process', '*onemon.registry', '*onemon.syscalli',
    '*onemon.networkflow', '*onemon.section', '*onemon.log',
    '*onemon.filecontents', '*onemon.notification', '*onemon.whois',
    '*onemon.dumped', '*onemon.event', '*onemon.file', '*onemon.suspicious',
    '*onemon.vminfo'
]

def log_event_kind(event, kind, dirname):
    """Logs the specified event to the file for its kind in the dirname.
    Creates dirname is it does not exist. Only event kinds that are prevent
    in the whitelist are logged."""
    if kind.lower() not in whitelist:
        print(f"Not allowed: {kind}")
        return

    if not os.path.isdir(dirname):
        os.mkdir(dirname)

    onemon_kind = kind.split(".", 1)
    if len(onemon_kind) < 2:
        return

    shortkind = onemon_kind[1].lower()
    kindfile = os.path.join(dirname, shortkind)

    with open(kindfile, "a") as fp:
        fp.write(f"{json.dumps(event)}\n")

if __name__ == "__main__":

    parser = argparse.ArgumentParser()
    parser.add_argument("jsonfile", type=str, help="Path to a onemon newline separated json dump.")
    parser.add_argument("-dumpdir", type=str, help="Dump all events of each category to the given directory.")
    args = parser.parse_args()

    jsonfile = args.jsonfile
    if not os.path.isfile(jsonfile):
        sys.exit(f"{jsonfile} does not exist")

    types = {}
    with open(jsonfile, "r") as fp:
        while True:
            line = fp.readline()
            if not line:
                break

            try:
                parsed = json.loads(line)
            except json.JSONDecodeError as e:
                print(f"Error: {e}")
                continue

            kind = parsed.get("kind")
            if not kind:
                continue

            if kind not in types:
                types[kind] = 0
            types[kind] += 1

            sigs = event_sigs.get(kind)
            if sigs:
                for signature in sigs:
                    print(signature(parsed))

            if args.dumpdir:
                log_event_kind(parsed, kind, args.dumpdir)

    pprint.pprint(types)

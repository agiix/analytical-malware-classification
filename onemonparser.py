#!/usr/bin/env python3

import argparse
import os
import sys

import category
from abstracts import Signature
from threemon import reader
from utils import enumerate_plugins

if __name__ == "__main__":

    parser = argparse.ArgumentParser()
    parser.add_argument("pbfile", type=str, help="Path to a Threemon behavioral log file.")
    args = parser.parse_args()

    pbfilepath = args.pbfile
    if not os.path.isfile(pbfilepath):
        sys.exit("File does not exist.")

    sigs = [sig() for sig in enumerate_plugins("sigs", globals(), Signature)]

    with open(pbfilepath, "rb") as fp:
        for kind, event in reader.read_events(fp):
            for sig in sigs:
                if kind not in sig.event_types:
                    continue

                if sig.wants_event(event):
                    sig.give_event(kind, event)


    for sig in sigs:
        if sig.matched:
            print(
                f"Signature triggered: '{sig.__class__.__name__}'. "
                f"{sig.description}"
            )

    for category in category.find_categories(sigs):
        print(f"Determined category: {category}")

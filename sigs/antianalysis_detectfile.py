from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2


class AntiAnalysisDetectFile(Signature):

    event_types = [EventTypes.PROCESS]

    description = "Attempts to identify installed analysis tools by a known file location"
    TTPS = ["T1063"]

    file_indicators = [
        ":\\analysis",
        ":\\iDEFENSE",
        ":\\stuff\\odbg110",
        ":\\gnu\\bin",
        ":\\Virus\\ Analysis",
        ":\\popupkiller\\.exe",
        ":\\tools\\execute\\.exe",
        ":\\MDS\\WinDump\\.exe",
        ":\\guest_tools\\start\\.bat",
        ":\\tools\\aswsnx",
        ":\\tools\\decodezeus",
        ":\\tool\\malmon",
        ":\\sandcastle\\tools",
        ":\\tsl\\raptorclient\\.exe",
        ":\\kit\\procexp\\.exe",
        ":\\winap\\ckmon\\.pyw",
        ":\\vmremote\\vmremoteguest\\.exe",
        ":\\Program\\ Files(\\ \\(x86\\))?\\Fiddler",
        ":\\ComboFix",
    ]

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False

    def process_event(self, process):
        if process.image[0].isalpha():
            for i in self.file_indicators:
                if i in process.image:
                    self.trigger()
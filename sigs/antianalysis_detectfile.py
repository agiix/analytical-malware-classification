from abstracts import Signature
from threemon.reader import EventTypes
from threemon import file_pb2


class AntiAnalysisDetectFile(Signature):

    event_types = [EventTypes.FILE]

    description = "Attempts to identify installed analysis tools by a known file location"
    TTPS = ["T1063"]

    file_indicators = [
        ":\\analysis",
        ":\\iDEFENSE",
        ":\\stuff\\odbg110",
        ":\\gnu\\bin",
        ":\\Virus\\ Analysis",
        ":\\popupkiller\\.exe",
        ":\\tools\\execute\\.exe",
        ":\\MDS\\WinDump\\.exe",
        ":\\guest_tools\\start\\.bat",
        ":\\tools\\aswsnx",
        ":\\tools\\decodezeus",
        ":\\tool\\malmon",
        ":\\sandcastle\\tools",
        ":\\tsl\\raptorclient\\.exe",
        ":\\kit\\procexp\\.exe",
        ":\\winap\\ckmon\\.pyw",
        ":\\vmremote\\vmremoteguest\\.exe",
        ":\\Program\\ Files(\\ \\(x86\\))?\\Fiddler",
        ":\\ComboFix",
    ]

    def wants_event(self, file_event):
        if file_event.kind == file_pb2.OpenRead:
            return True
        return False

    def file_event(self, file):
        if file.srcpath[0].isalpha():
            for i in self.file_indicators:
                if i in file.srcpath:
                    self.trigger()

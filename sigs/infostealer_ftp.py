from abstracts import Signature
from threemon.reader import EventTypes
from threemon import file_pb2, registry_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/infostealer_ftp.py

class FTPStealer(Signature):

    event_types = [EventTypes.FILE, EventTypes.REGISTRY]

    description = "Harvests credentials from local FTP client softwares"
    TTPS = ["T1081", "T1003", "T1005"]

    file_indicators = [
        ".*\\\\CuteFTP\\\\sm\\.dat$",
        ".*\\\\CuteFTP\\ Lite\\\\sm\\.dat$",
        ".*\\\\CuteFTP\\ Pro\\\\sm\\.dat$",
        ".*\\\\FlashFXP\\\\.*\\\\(Sites|Quick|History)\\.dat$",
        ".*\\\\VanDyke\\\\Config\\\\Sessions.*",
        ".*\\\\FTP Explorer\\\\",
        ".*\\\\LeechFTP\\\\",
        ".*\\\\SmartFTP\\\\",
        ".*\\\\TurboFTP\\\\",
        ".*\\\\FTPRush\\\\",
        ".*\\\\LeapFTP\\\\",
        ".*\\\\FTPGetter\\\\",
        ".*\\\\ALFTP\\\\",
        ".*\\\\Ipswitch\\\\WS_FTP.*",
        ".*\\\\wcx_ftp\\.ini$",
        ".*\\\\32BitFtp\\.ini$",
        ".*\\\\CoffeeCup\\ Software\\\\SharedSettings.*(sqlite|ccs)$",
        ".*\\\\ExpanDrive\\\\drives\\.js$",
        ".*\\\\FileZilla\\\\(sitemanager|recentservers|filezilla)\\.xml$",
    ]

    reg_indicators = [
        ".*\\\\Software\\\\Far.*\\\\Hosts$",
        ".*\\\\Software\\\\Far.*\\\\FTPHost$",
        ".*\\\\Software\\\\Far.*?\\\\FTP\\\\Hosts$",
        ".*\\\\Software\\\\TurboFTP\\\\",
        ".*\\\\Software\\\\Robo-FTP.*\\\\FTPServers$",
        ".*\\\\Software\\\\Ghisler\\\\Windows Commander$",
        ".*\\\\Software\\\\Ghisler\\\\Total Commander$",
        ".*\\\\Software\\\\BPFTP\\\\",
        ".*\\\\Software\\\\BulletProof Software\\\\BulletProof FTP Client\\\\",
        ".*\\\\Software\\\\BPFTP\\\\Bullet\\ Proof\\ FTP",
        ".*\\\\Software\\\\FTP\\ Explorer\\\\Profiles",
        ".*\\\\CuteFTP\\ .\\ Professional\\\\QCToolbar",
        ".*\\\\Software\\\\VanDyke\\\\SecureFX",
        ".*\\\\Software\\\\South\\ River\\ Technologies\\\\WebDrive",
        ".*\\\\Software\\\\LinasFTP",
        ".*\\\\Software\\\\SoftX\\.org\\\\FTPClient",
        ".*\\\\Software\\\\Sota\\\\FFFTP",
        ".*\\\\Software\\\\LeechFTP",
        ".*\\\\Software\\\\CoffeeCup\\ Software",
        ".*\\\\Software\\\\FlashFXP",
        ".*\\\\Software\\\\FTP\\ Explorer\\\\FTP\\ Explorer",
        ".*\\\\Software\\\\FlashPeak\\\\BlazeFtp",
        ".*\\\\Software\\\\LeapWare",
        ".*\\\\Software\\\\SimonTatham\\\\PuTTY",
        ".*\\\\Software\\\\Cryer\\\\WebSitePublisher",
        ".*\\\\Software\\\\ExpanDrive",
        ".*\\\\Software\\\\Martin\\ Prikryl",
        ".*\\\\Software\\\\AceBIT",
        ".*\\\\Software\\\\Nico\\ Mak\\ Computing\\\\WinZip",
        ".*\\\\Software\\\\FTPWare\\\\CoreFTP",    
    ]

    # By defining which file_event is needed for this class, do I
    # automatically exclude every registry event? Can I define 2 wanted 
    # events even it i don't know which to expect from registry?
    #def wants_event(self, file_event):


    def file_registry_event(self, file, registry):
        for f in self.file_indicators:
            if self.check_value(pattern=f, subject=file.srcpath, regex=True, all=True):
                self.trigger()
        for reg in self.reg_indicators:
            if self.check_value(pattern=reg, subject=registry.path, regex=True, all=True):
                self.trigger()

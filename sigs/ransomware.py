from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2, registry_pb2, file_pb2
from report import mapping


"""line would be a parsed entry from the onemon json file.
delshadowcopies expects an entry of the "*onemon.Process" category
and looks for the command key and keywords like 'wmic shadowcopy
delete' or 'vssadmin delete shadows'Â£
Suited for Windows 7 & 10
"""

class DelShadowCopy(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "A shadowcopy was deleted"
    TTPS = ["T1490"]
    events = {}

    _vssadmin_tokens = ["vssadmin", "delete", "shadows"]
    _wmic_tokens = ["wmic", "shadowcopy", "delete"]

    def process_event(self, process):
        if all(token in process.command.lower()
               for token in self._vssadmin_tokens):
                    self.events = mapping(self.events, process)
                    self.trigger()
        if all(token in process.command.lower()
               for token in self._wmic_tokens):
                    self.events = mapping(self.events, process)
                    self.trigger()

class CryptoRegistries(Signature):

    event_types = {
        EventTypes.REGISTRY: {
            registry_pb2.QueryValueKey,registry_pb2.OpenKeyEx,
            registry_pb2.EnumerateKey,registry_pb2.CreateKeyEx
        }
    }
    
    description = "Query to Microsoft's cryptography registry key found"
    TTPS = ["None"]
    events = {}
    
    _regkey = "REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography"

    def registry_event(self, registry):
        if self._regkey.upper() in registry.path.upper():
            self.events = mapping(self.events, registry)
            self.trigger()


class FileOpsFrequency(Signature):

    event_types = {
        EventTypes.FILE: {
            file_pb2.OpenRead, file_pb2.OpenModify,
            file_pb2.Rename, file_pb2.Delete, file_pb2.CreateModify
        }
    }

    description = "Unusual high frequency of file operations detected"
    TTPS = ["T1486"]
    events = {}

    threshold = 40
    fileops = 0
    
    def checkfrequency(self, file):
        self.fileops += 1
        if self.fileops > self.threshold:
            self.events = mapping(self.events, file)
            self.trigger()

from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2



"""line would be a parsed entry from the onemon json file.
delshadowcopies expects an entry of the "*onemon.Process" category
and looks for the command key and keywords like 'wmic shadowcopy
delete' or 'vssadmin delete shadows'
Suited for Windows 7 & 10
"""

class DelShadowCopy(Signature):

    event_types = [EventTypes.PROCESS]

    description = "A shadowcopy was deleted"
    TTPS = ["Dankmemes"]

    _vssadmin_tokens = ["vssadmin", "delete", "shadows"]
    _wmic_tokens = ["wmic", "shadowcopy", "delete"]

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True

        return False

    def process_event(self, process):
        self.trigger()
        if all(token in process.command.lower()
               for token in self._vssadmin_tokens):
            self.trigger()
        if all(token in process.command.lower()
               for token in self._wmic_tokens):
            self.trigger()

from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2, registry_pb2, file_pb2



"""line would be a parsed entry from the onemon json file.
delshadowcopies expects an entry of the "*onemon.Process" category
and looks for the command key and keywords like 'wmic shadowcopy
delete' or 'vssadmin delete shadows'Â£
Suited for Windows 7 & 10
"""

class DelShadowCopy(Signature):

    event_types = [EventTypes.PROCESS]

    description = "A shadowcopy was deleted"
    TTPS = ["T1047","T1490"]

    _vssadmin_tokens = ["vssadmin", "delete", "shadows"]
    _wmic_tokens = ["wmic", "shadowcopy", "delete"]

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False

    def process_event(self, process):
        #self.trigger()
        if all(token in process.command.lower()
               for token in self._vssadmin_tokens):
            self.trigger()
        if all(token in process.command.lower()
               for token in self._wmic_tokens):
            self.trigger()

class CryptoRegistries(Signature):

    event_types = [EventTypes.REGISTRY]
    
    description = "Query to Microsoft's cryptography registry key found"
    _regkey = "REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography"

    def wants_event(self, registry_event):
        if (registry_event.RegistryKind == registry_pb2.QueryValueKey or
            registry_event.RegistryKind == registry_pb2.OpenKeyEx or
            registry_event.RegistryKind == registry_pb2.EnumerateKey or
            registry_event.RegistryKind == registry_pb2.CreateKeyEx):
            return True
        return False

    def process_event(self, registry):
        if self._regkey.upper() in registry.path.upper():
            self.trigger()


class FileOpsFrequency(Signature):

    event_types = [EventTypes.FILE]

    description = "Unusual high frequency of file operations detected"
    TTPS = ["Not specified"]
    threshold = 40
    fileops = 0

    def wants_event(self, file_event):
        if (file_event.FileAccess == file_pb2.OpenRead or
            file_event.FileAccess == file_pb2.OpenModify or
            file_event.FileAccess == file_pb2.Rename or
            file_event.FileAccess == file_pb2.Delete):
            return True
        return False
    
    def checkfrequency(self, file):
        self.fileops += 1
        if self.fileops > self.threshold:
            self.trigger()

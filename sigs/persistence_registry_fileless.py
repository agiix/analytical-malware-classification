from abstracts import Signature
from threemon.reader import EventTypes
from threemon import registry_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/persistence_registry_fileless.py

class PersistenceRegistryJavaScript(Signature):
    event_types = [EventTypes.REGISTRY]

    description = "Used JavaScript in registry key value likely for persistance"
    TTPS = ["T1112"]


    def wants_event(self, registry_event):
        if registry_event.kind in (registry_pb2.SetValueKeyStr, registry_pb2.SetValueKeyDat, 
            registry_pb2.SetValueKeyInt, registry_pb2.SetInformationKey, registry_pb2.SetKeySecurity):
            return True
        return False


    def registry_event(self, registry):
        if "javascript:" in registry.values.lower():
            self.trigger()


class PersistenceRegistryEXE(Signature):
    event_types = [EventTypes.REGISTRY]

    description = "Stores an executable in the registry"
    TTPS = ["T1112"]


    def wants_event(self, registry_event):
        if registry_event.kind in (registry_pb2.SetValueKeyStr, registry_pb2.SetValueKeyDat, 
            registry_pb2.SetValueKeyInt, registry_pb2.SetInformationKey, registry_pb2.SetKeySecurity):
            return True
        return False


    def registry_event(self, registry):
        if registry.values.startswith("MZ"):
            self.trigger()


class PersistenceRegistryPowershell(Signature):
    event_types = [EventTypes.REGISTRY]

    description = "Stores PowerShell commands in the registry likely for persistence"
    TTPS = ["T1112"]


    def wants_event(self, registry_event):
        if registry_event.kind in (registry_pb2.SetValueKeyStr, registry_pb2.SetValueKeyDat, 
            registry_pb2.SetValueKeyInt, registry_pb2.SetInformationKey, registry_pb2.SetKeySecurity):
            return True
        return False

    def registry_event(self, registry):
        if registry.values.lower() in ("powershell.exe", "powershell "):
            self.trigger()

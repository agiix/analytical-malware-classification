from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2
import re

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/stealth_systemprocname.py

class StealthSystemProcName(Signature):

    event_types = [EventTypes.PROCESS]

    description = "Created a process named as a common system process"
    TTPS = ["T1036"]

    systemprocs = [
        "csrss.exe",
        "explorer.exe",
        "lsass.exe",
        "spoolsv.exe",
        "services.exe",
        "svchost.exe",
        "taskmgr.exe",
        "winlogin.exe",
    ]


    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False


    def process_event(self, process):
        for sys in self.systemprocs:
            if process.image.endswith(sys):
                if not process.image.endswith("svchost.exe"):
                    self.trigger()


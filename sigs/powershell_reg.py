from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2
import re
import shlex
from report import mapping

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/powershell_reg.py

class PowershellRegAdd(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Powershell script adds registry entries"
    TTPS = ["T1086"]
    events = {}

    def process_event(self, process):
        lower = "".join(process.command).lower()
        if "powershell" in lower and "reg add" in lower:
            self.events = mapping(self.events, process)
            self.trigger()

        encre = re.compile("\-[e^]{1,2}[ncodema^]+")
        lower = process.command.lower()
        if encre.search(lower):
                # Powershell is b64 encoded
            script, args = None, shlex.split(process.command)
            for idx, arg in enumerate(args):
                if not encre.search(arg.lower()):
                        # Not the encoded argument
                    continue

                try:
                    script = args[idx+1].decode("base64").decode("utf16")
                    if "reg add" in script.lower():
                        self.events = mapping(self.events, process)
                        self.trigger()
                except:
                    pass

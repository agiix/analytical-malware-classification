from abstracts import Signature
from threemon.reader import EventTypes
from threemon import registry_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/creates_null_reg_entry.py

# Other bypass signatures need to be added, since there are techniques that don't use regsvr32
class CreatesNullRegistryEntry(Signature):

    event_types = {
        EventTypes.REGISTRY: {
            registry_pb2.SetValueKeyStr,registry_pb2.SetValueKeyDat,
            registry_pb2.CreateKeyEx,registry_pb2.CreateKey
        }
    }

    description = "Creates a registry value with a null byte to avoid detection"
    TTPS = ["T1054", "T1112"]

    null_byte = "\\x00"

    # Is here only values to check or should valued also be checked?
    def registry_event(self, registry):
        if registry.values.startswith(self.null_byte):
            self.trigger()


from abstracts import Signature
from threemon.reader import EventTypes
from threemon import suspicious_pb2, file_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/creates_exe.py

class CreatesExe(Signature):

    event_types = {
        EventTypes.FILE: {file_pb2.OpenModify, file_pb2.CreateModify, file_pb2.CreateRead}
    }

    description = "Creates executable files on the filesystem"
    TTPS = ["T1129"]

    file_pattern = (
        ".*\\.(bat|cmd|com|cpl|dll|exe|js|jse|lnk|msi|msh|msh1|msh2|mshxml|"
        "msh1xml|msh2xml|ocx|pif|psc1|psc2|ps1|ps1xml|ps2|ps2xml|reg|scf|scr|"
        "vb|vbe|vbs|ws|wsc|wse|wsh)$"
    )

    def process_event(self, file):
        for pat in self.file_pattern:
            if self.check_value(pattern=pat, subject=file.srcpath, regex=True, all=True):
                self.trigger()


class CreatesUserFolderEXE(Signature):

    event_types = {
        EventTypes.FILE: {file_pb2.OpenModify, file_pb2.CreateModify, file_pb2.CreateRead}
    }

    description = "Creates an executable file in a user folder"
    TTPS = ["T1129"]

    directories_re = [
        "^[a-zA-Z]:\\\\Users\\\\[^\\\\]+\\\\AppData\\\\.*",
        "^[a-zA-Z]:\\\\Documents\\ and\\ Settings\\\\[^\\\\]+\\\\Local\\ Settings\\\\.*",
    ]

    def process_event(self, file):
        for pat in self.file_pattern:
            if self.check_value(pattern=pat, subject=file.srcpath, regex=True, all=True):
                if ".exe" in file.srcpath:
                    self.trigger()

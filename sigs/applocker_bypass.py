from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/applocker_bypass.py

# Other bypass signatures need to be added, since there are techniques that don't use regsvr32
class AppLockerBypass(Signature):
    event_types = [EventTypes.PROCESS]

    description = "Powershell script bypasses AppLocker by calling regsvr32"
    TTPS = ["T1086", "T1117"]

    bypass_indicators = [
        "regsvr32",
        "/i:",
        "/s",
        "/n",
        ".dll"
    ]

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False


    def process_event(self, process):
        if all(c in process.command.lower() for c in self.bypass_indicators):
            self.trigger()

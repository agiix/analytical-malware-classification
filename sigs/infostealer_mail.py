from abstracts import Signature
from threemon.reader import EventTypes
from threemon import file_pb2, registry_pb2

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/infostealer_mail.py

class MailStealer(Signature):

    event_types = [EventTypes.FILE, EventTypes.REGISTRY]

    description = "Harvests information related to installed instant messenger clients"
    TTPS = ["T1081", "T1003", "T1005"]

    file_indicators = [
        ".*\\\\Software\\\\(Wow6432Node\\\\)?IncrediMail"
        ".*\\\\RIT\\\\The\\ Bat\\!",
        ".*\\\\Microsoft\\\\Internet\\ Account\\ Manager\\\\Accounts",
        ".*\\\\Software\\\\Microsoft\\\\Windows\\ Mail",
        ".*\\\\Software\\\\(Wow6432Node\\\\)?Microsoft\\\\Windows\\ Live\\ Mail",
        ".*\\\\Microsoft\\\\Windows\\ Messaging\\ Subsystem\\\\MSMapiApps",
        ".*\\\\Microsoft\\\\Windows\\ Messaging\\ Subsystem\\\\Profiles.*",
        ".*\\\\Software\\\\Microsoft\\\\Windows\\ NT\\\\CurrentVersion\\\\Windows\\ Messaging\\ Subsystem",
        ".*\\\\Software\\\\Microsoft\\\\Internet\\ Account\\ Manager",
        ".*\\\\Software\\\\Microsoft\\\\Office\\\\Outlook\\\\OMI\\ Account\\ Manager",
        ".*\\\\Software\\\\RimArts\\\\B2\\\\Settings",
        ".*\\\\Software\\\\Poco\\ Systems\\ Inc",
        ".*\\\\Software\\\\Mozilla\\\\Mozilla\\ Thunderbird",
        ".*\\\\Software\\\\(Wow6432Node\\\\)?Clients\\\\Mail",
        ".*\\\\Microsoft\\\\Office\\\\.*\\\\Outlook\\\\Profiles\\\\Outlook",
        ".*\\\\Software\\\\Google\\\\Google\\ Talk",
    ]

    reg_indicators = [
        ".*\\\\The\\ Bat!\\\\",
        ".*\\\\ICQ\\\\",
        ".*\\\\Miranda\\\\",
        ".*\\\\SmartFTP\\\\",
        ".*\\\\QIP\\\\",
        ".*\.pst$",
        ".*\\\\Microsoft\\\\Windows\\ Live\\ Mail.*",
        ".*\\\\Microsoft\\\\Address\\ Book\\\\.*\.wab$",
        ".*\\\\Microsoft\\\\Outlook\\ Express\\\\.*\.dbx$",
        ".*\\\\Foxmail\\\\mail\\\\.*\\\\Account\.stg$",
        ".*\\\\Foxmail.*\\\\Accounts\.tdat$",
        ".*\\\\Thunderbird\\\\Profiles\\\\.*\.default$",
        ".*\\\\AppData\\\\Roaming\\\\Thunderbird\\\\profiles.ini$",
    ]

    # By defining which file_event is needed for this class, do I
    # automatically exclude every registry event? Can I define 2 wanted 
    # events even it i don't know which to expect from registry?
    #def wants_event(self, file_event):


    def file_registry_event(self, file, registry):
        for f in self.file_indicators:
            if self.check_value(pattern=f, subject=file.srcpath, regex=True, all=True):
                self.trigger()
        for reg in self.reg_indicators:
            if self.check_value(pattern=reg, subject=registry.path, regex=True, all=True):
                self.trigger()

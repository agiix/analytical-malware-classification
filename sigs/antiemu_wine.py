from abstracts import Signature
from threemon.reader import EventTypes
from threemon import suspicious_pb2, registry_pb2

class WineDetect(Signature):

    event_types = [EventTypes.SUSPICIOUS, EventTypes.REGISTRY]

    description = "Detects the presence of Wine emulator"
    ttp = ["T1057"]

    # Could be logged as Suspicious event?
    filter_apinames = "LdrGetProcedureAddress",

    indicators = [
        "HKEY_CURRENT_USER\\Software\\Wine",
    ]

    # Doesn't seem to be detectable in threemon
    """
    func_indicators = [
        "wine_get_version",
        "wine_nt_to_unix_file_name",
        "wine_get_unix_file_name",
        "wine_server_call",
    ]"""

    # Skippable for now, since it's not clear yet what
    # kind of registry event to expect and the suspicious
    # event doesn't seem in need for a wants_event function anyways
    #def wants_event(self, process_event):


    def suspicious_event(self, suspicious):
        if self.filter_apinames in suspicious.event:
            self.trigger()

    def registry_event(self, registry):
        for i in self.indicators:
            if i in registry.path:
                self.trigger()

from abstracts import Signature
from threemon.reader import EventTypes
from threemon import file_pb2
import re

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/persistence_ads.py

class ADS(Signature):

    event_types = [EventTypes.FILE]

    description = "Creates an Alternate Data Stream (ADS)"
    TTPS = ["T1096"]


    def wants_event(self, file_event):
        if file_event.kind == (file_pb2.CreateRead, file_pb2.CreateModify):
            return True
        return False


    def file_event(self, file):
        if ":" in file.srcpath.split("\\")[-1]:
            if not file.srcpath.lower().startswith("c:\\dosdevices\\") and not file.srcpath[-1] == ":":
                if not file.srcpath.startswith("\\??\\http://") and not file.srcpath.endswith(":Zone.Identifier") and not re.match(r'^[A-Z]?:\\(Users|Documents and Settings)\\[^\\]+\\Favorites\\Links\\Suggested Sites\.url:favicon$', file.srcpath, re.IGNORECASE):
                    self.trigger()

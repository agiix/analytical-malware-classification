from abstracts import Signature
from threemon.reader import EventTypes
from threemon import process_pb2
from report import mapping

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/windows_utilities.py

utilities = [
    "at ",
    "at.exe",
    "attrib",
    "chcp",
    "del ",
    "del.exe",
    "dir ",
    "dir.exe",
    "driverquery",
    "erase ",
    "erase.exe",
    "fsutil",
    "getmac",
    "ipconfig",
    "nbtstat",
    "net ",
    "net.exe",
    "netsh",
    "netstat",
    "nslookup",
    "pathping",
    "ping ",
    "ping.exe",
    "qwinsta",
    "reg ",
    "reg.exe",
    "regsrv32",
    "route",
    "runas",
    "rwinsta",
    "sc ",
    "sc.exe",
    "schtasks",
    "shutdown",
    "sigverif",
    "systeminfo",
    "tasklist",
    "taskkill",
    "telnet",
    "whoami",
    "wmic",
    "wusa",
]

risk_utilities = [
    "bitsadmin",
    "cacls",
    "csvde",
    "dsquery",
    "icacls",
    "nltest",
    "rexec",
    "sdbinst",
    "volumeid",
    "vssadmin",
    "wevtutil",
    "whois",
    "xcacls",
]

sysinternals = [
    "accesschk",
    "accessenum",
    "adexplorer",
    "adinsight",
    "adrestore",
    "autologon",
    "autoruns",
    "bginfo",
    "bluescreen",
    "clockres",
    "contig",
    "coreinfo",
    "ctrl2cap",
    "debugview",
    "desktops",
    "disk2vhd",
    "diskext",
    "diskmon",
    "du ",
    "du.exe",
    "efsdump",
    "findlinks",
    "handle ",
    "handle.exe",
    "hex2dec",
    "junction",
    "ldmdump",
    "listdlls",
    "livekd",
    "loadorder",
    "logonsessions",
    "movefile",
    "notmyfault",
    "ntfsinfo",
    "pendmoves",
    "pipelist",
    "portmon",
    "procdump",
    "psexec",
    "psfile",
    "bginfo",
    "psgetsid",
    "psinfo",
    "pskill",
    "pslist",
    "psloggedon",
    "psloglist",
    "pspasswd",
    "psping",
    "psservice",
    "psshutdown",
    "pssuspend",
    "pstools",
    "rammap",
    "regdelnull",
    "ru ",
    "ru.exe",
    "regjump",
    "sdelete",
    "shareenum",
    "shellrunas",
    "sigcheck",
    "streams ",
    "streams.exe",
    "strings ",
    "strings.exe",
    "sync ",
    "sync.exe",
    "sysmon",
    "tcpview",
    "vmmap",
    "volumeid",
    "whois",
    "winobj",
    "zoomit",
]

class UsesWindowsUtilities(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Uses Windows utilities for basic Windows functionality"
    TTPS = ["T1053"]
    events = {}

    def process_event(self, process):
        for u in utilities:
            if u in process.command.lower():
                self.events = mapping(self.events, process)
                self.trigger()


class SuspiciousCommandTools(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Uses suspicious command line tools or Windows utilities"
    TTPS = ["None"]
    events = {}

    def process_event(self, process):
        for u in risk_utilities:
            if u in process.command.lower():
                self.events = mapping(self.events, process)
                self.trigger()

class SysInternalsToolsUsage(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Uses Sysinternals tools in order to add additional command line functionality"
    TTPS = ["None"]
    events = {}

    def process_event(self, process):
        for u in sysinternals:
            if u in process.command.lower():
                self.events = mapping(self.events, process)
                self.trigger()


class AddsUser(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Uses windows command to add a user to the system"
    TTPS = ["T1136"]
    events = {}

    def process_event(self, process):
        if process.command.lower().startswith("net") and "user /add" in process.command.lower():
            self.events = mapping(self.events, process)
            self.trigger()

class AddsUserAdmin(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "Uses windows command to add a user to the administrator group"
    TTPS = ["T1098"]
    events = {}

    def process_event(self, process):
        if process.command.lower().startswith("net") and "localgroup administrators" in process.command.lower():
            self.events = mapping(self.events, process)
            self.trigger()
    
from abstracts import Signature
from threemon.reader import EventTypes
from threemon import mutant_pb2

class AntiVMSharedDevice(Signature):

    event_types = [EventTypes.MUTANT]

    description = "Tries to detect Sandboxie"
    TTPS = ["1057"]


    def wants_event(self, mutant_event):
        if mutant_event.action in (mutant_pb2.MutantCreate, mutant_pb2.MutantOpen):
            return True
        return False

    def mutant_event(self, mutant):
        if self.mutex in mutant.path:
            self.trigger()

        for filepath in self.check_file(pattern=".*sbiedll(\\.dll)?$", regex=True, all=True):
            self.mark_ioc("file", filepath)

        for dll in self.check_dll_loaded(pattern=".*sbiedll(\\.dll)?$", regex=True, all=True):
            self.mark_ioc("dll", dll)

        return self.has_marks()
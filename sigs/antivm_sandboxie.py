from abstracts import Signature
from threemon.reader import EventTypes
from threemon import mutant_pb2
from report import mapping

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/antivm_sandboxie.py

class SandboxieDetect(Signature):

    event_types = {
        EventTypes.PROCESS: {mutant_pb2.MutantCreate, mutant_pb2.MutantOpen}
    }

    description = "Tries to detect Sandboxie"
    TTPS = ["T1057"]
    events = {}

    mutexes_re = [
        ".*Sandboxie_SingleInstanceMutex_Control",
    ]

    def mutant_event(self, mutant):
        for m in self.mutexes_re:
            if self.check_value(pattern=m, subject=mutant.path, regex=True, all=True):
                self.events = mapping(self.events, mutant)
                self.trigger()

    # What filepath and dll are being used in that signature? 
    """
        for filepath in self.check_file(pattern=".*sbiedll(\\.dll)?$", regex=True, all=True):
            self.mark_ioc("file", filepath)

        for dll in self.check_dll_loaded(pattern=".*sbiedll(\\.dll)?$", regex=True, all=True):
            self.mark_ioc("dll", dll)
    """


from abstracts import Signature
from threemon.reader import EventTypes
from threemon import file_pb2
from report import mapping

# Original Signature:
# https://github.com/cuckoosandbox/community/blob/master/modules/signatures/windows/antiav_detectfile.py

class AntiAVDetectFile(Signature):

    event_types = {
        EventTypes.FILE : {file_pb2.OpenRead}
    }

    description = "Attempts to identify installed AV products by installation directory"
    TTPS = ["T1063"]
    events = {}

    file_indicators = [
        ".*\\\\AVAST\\ Software",
        ".*\\\\Avira\\ GmbH",
        ".*\\\\Avira",
        ".*\\\\Kaspersky\\ Lab",
        ".*\\\\Kaspersky\\ Lab\\ Setup\\ Files",
        ".*\\\\DrWeb",
        ".*\\\\Norton\\ AntiVirus",
        ".*\\\\Norton\\ (Security with Backup|Internet Security)\\\\"
        ".*\\\\ESET",
        ".*\\\\Agnitum",
        ".*\\\\Panda\\ Security",
        ".*\\\\McAfee",
        ".*\\\\McAfee\.com",
        ".*\\\\Trend\\ Micro",
        ".*\\\\BitDefender",
        ".*\\\\ArcaBit",
        ".*\\\\Online\\ Solutions",
        ".*\\\\AnVir\\ Task\\ Manager",
        ".*\\\\Alwil\\ Software",
        ".*\\\\Symantec$",
        ".*\\\\AVG",
        ".*\\\\Xore",
        ".*\\\\Symantec\\ Shared",
        ".*\\\\a-squared\\ Anti-Malware",
        ".*\\\\a-squared\\ HiJackFree",
        ".*\\\\avg8",
        ".*\\\\Doctor\\ Web",
        ".*\\\\f-secure",
        ".*\\\\F-Secure\\ Internet\\ Security",
        ".*\\\\G\\ DATA",
        ".*\\\\P\\ Tools",
        ".*\\\\P\\ Tools\\ Internet\\ Security",
        ".*\\\\K7\\ Computing",
        ".*\\\\Vba32",
        ".*\\\\Sunbelt\\ Software",
        ".*\\\\FRISK\\ Software",
        ".*\\\\Security\\ Task\\ Manager",
        ".*\\\\Zillya\\ Antivirus",
        ".*\\\\Spyware\\ Terminator",
        ".*\\\\Lavasoft",
        ".*\\\\BlockPost",
        ".*\\\\DefenseWall\\ HIPS",
        ".*\\\\DefenseWall",
        ".*\\\\Microsoft\\ Antimalware",
        ".*\\\\Microsoft\\ Security\\ Essentials",
        ".*\\\\Sandboxie",
        ".*\\\\Positive\\ Technologies",
        ".*\\\\UAenter",
        ".*\\\\Malwarebytes",
        ".*\\\\Malwarebytes'\\ Anti-Malware",
        ".*\\\\Microsoft\\ Security\\ Client",
        ".*\\\\System32\\\\drivers\\\\kl1\\.sys",
        ".*\\\\System32\\\\drivers\\\\(tm((actmon|comm)\\.|e(vtmgr\\.|ext\\.)|(nciesc|tdi)\\.)|TMEBC32\\.)sys",
    ]

    def file_event(self, file):
        for f in self.file_indicators:
            if self.check_value(pattern=f, subject=file.srcpath, regex=True, all=True):
                self.events = mapping(self.events, file)
                self.trigger()

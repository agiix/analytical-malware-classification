from abstracts import Signature
from threemon.reader import EventTypes
from threemon import registry_pb2, process_pb2, suspicious_pb2
from report import mapping

class MachineGuid(Signature):
    
    event_types = {
        EventTypes.REGISTRY: {
            registry_pb2.EnumerateKey,registry_pb2.EnumerateValueKey,registry_pb2.OpenKey, 
            registry_pb2.OpenKeyEx,registry_pb2.QueryKey,registry_pb2.QueryValueKey
        }
    }

    description = "Dected query to MachineGuid reg key, which is used as a unique identifier for a machine "
    TTPS = ["T1082"]
    events = {}

    _regkey = "MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid"

    def registry_event(self, registry):
        if self._regkey in registry.path:
            self.events = mapping(self.events, registry)
            self.trigger()


class SuspiciousSpwan(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "A suspicious new process was spawned"
    TTPS = ["None"]
    events = {}

    def process_event(self, process):
        if process.orig == False:
            self.events = mapping(self.events,process)
            self.trigger()


class ExecuteWmiPrsve(Signature):

    event_types = {
        EventTypes.PROCESS: {process_pb2.Create}
    }

    description = "WMI could be used to launch Powershell"
    TTPS = ["T1047"]
    events = {}

    _wmipath = "C:\\Windows\\system32\\wbem\\wmiprvse.exe"

    def process_event(self, process):
        if self._wmipath in process.command:
            self.events = mapping(self.events, process)
            self.trigger()

class ProcessInjectionIndicator(Signature):

    event_types = {
        EventTypes.SUSPICIOUS: {suspicious_pb2.WriteProcessMemory}
    }

    description = "Indicator for possible process injection"
    TTPS = ["T1055"]
    events = {}

    def suspicious_event(self, suspicious):
        self.events = mapping(self.events,suspicious)
        self.trigger()

from abstracts import Signature
from threemon.reader import EventTypes
from threemon import registry_pb2, process_pb2

class MachineGuid(Signature):
    
    event_types = [EventTypes.REGISTRY]

    description = "Dected query to MachineGuid reg key, which is used as a unique identifier for a machine "
    TTPS = ["T1082"]
    _regkey = "MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid"

    def registry_event(self, registry):
        if self._regkey in registry.path:
            self.trigger()


class SuspiciousSpwan(Signature):

    event_types = [EventTypes.PROCESS]

    description = "A suspicious new process was spawned"
    TTPS = ["No ID yet"]

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False

    def process_event(self, process):
        if process_pb2.orig == False:
            self.trigger()


class ExecuteWmiPrsve(Signature):

    event_types = [EventTypes.PROCESS]

    description = "WMI could be used to launch Powershell"
    TTPS = ["T1047"]

    _wmipath = "C:\\Windows\\system32\\wbem\\wmiprvse.exe"

    def wants_event(self, process_event):
        if process_event.status == process_pb2.Create:
            return True
        return False

    def process_event(self, process):
        if self._wmipath in process.command:
            self.trigger()

class ProcessInjectionIndicator(Signature):

    event_types = [EventTypes.SUSPICIOUS]

    description = "Indicator for possible process injection"
    TTPS = ["T1055"]

    def suspicious_event(self, process):
        if self.event == "WriteProcessMemory":
            self.trigger()

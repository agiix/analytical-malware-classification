import json
import sys
import os.path

dump = False
dirname = ""

if len(sys.argv) > 1 and sys.argv[1].lower() == "help":
    print('First argument specifies which json file to parse')
    print('If the second argument equals "dump" every line will be written in a file named after its category')
    sys.exit()
if len(sys.argv) < 2:
    print('Please provide a onemon-json file to parse')
    sys.exit()
if len(sys.argv) > 2 and sys.argv[2].lower() == "dump":
    dump = True
if len(sys.argv) > 1:
    base = os.path.basename(sys.argv[1])
    split = os.path.splitext(base)
    dirname = split[0]

allonemon = 0
kindkeys = {
            "*onemon.Registry": 0, 
            "*onemon.File": 0, 
            "*onemon.Section": 0, 
            "*onemon.NetworkFlow": 0, 
            "*onemon.Dumped": 0, 
            "*onemon.Suspicious": 0, 
            "*onemon.SyscallI": 0, 
            "*onemon.NetworkListen": 0,
            "*onemon.Process": 0,
            "*onemon.Event": 0,
            "*onemon.FileContents": 0,
            "*onemon.Whois": 0,
            "*onemon.Vminfo": 0,
            "*onemon.Mutant": 0,
            "*onemon.SyscallBBB": 0,
            "*onemon.Notification": 0,
            "*onemon.Log": 0,
            }
            
def parse():
    for line in open(sys.argv[1], 'r'):
        global allonemon
        allonemon += 1
        x = json.loads(line)
        if x['kind'] in kindkeys.keys():
            kindkeys[x['kind']] += 1
            if dump == True:
                fname = x['kind']
                fname = fname.lstrip('*onemon.').lower()
                writetofile(fname,line)
        else:
            print("Unknown onemon log event:",x['kind'])

def printresult():
    matched = 0
    print("-----------------------------------------------")    
    print("Parsed",allonemon,"onemon events")
    print("-----------------------------------------------")
    for key, value in kindkeys.items():
        if len(key) < 15:
            print(key,"\t\t\t",value)
        else:
            print(key,"\t\t",value)
    for i in kindkeys.values():
        matched += i
    if allonemon - matched > 0:
        print("-----------------------------------------------")
        print(allonemon - matched,"onemon event(s) could not be categorized")
        print("-----------------------------------------------")

def writetofile(fname, line):
    if os.path.isdir(dirname) == False:
        print("Creating Folder")
        os.makedirs(dirname)
    if os.path.isfile(fname) == True:
        with open(dirname + "/" + fname, "a") as dump:
            dump.write("\n" + line)
    else:
        with open(dirname + "/" + fname, "w") as dump:
            dump.write(line)


parse()
printresult()

from threemon import (
    file_pb2, registry_pb2, suspicious_pb2, inject_pb2, mutant_pb2, 
    notification_pb2, process_pb2, whois_pb2, thread_pb2, network_pb2, vminfo_pb2
)
from abstracts import Signature
from threemon import reader
from utils import enumerate_plugins

import socket
import struct

import json
from reportlab.pdfgen import canvas
from reportlab.platypus import Table
from reportlab.platypus import SimpleDocTemplate

from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import Paragraph, Image
from reportlab.lib import colors

def mapping(events, event):
    if isinstance(event,process_pb2.Process):
        if 'Process' in events:
            events['Process']['Command'].append(event.command)
            events['Process']['Image'].append(event.image)
            events['Process']['Status'].append(process_pb2.ProcessStatus.Name(event.status))
            events['Process']['ParentProcid'].append(event.parentprocid)
            events['Process']['Procid'].append(event.procid)
            events['Process']['Ppid'].append(event.ppid)
            events['Process']['Pid'].append(event.pid)
        else:
            events['Process'] = {}
            events['Process']['Command'] = [event.command]    
            events['Process']['Image'] = [event.image]
            events['Process']['Status'] = [process_pb2.ProcessStatus.Name(event.status)]   
            events['Process']['ParentProcid'] = [event.parentprocid] 
            events['Process']['Procid'] = [event.procid] 
            events['Process']['Ppid'] = [event.ppid] 
            events['Process']['Pid'] = [event.pid]  

    if isinstance(event,registry_pb2.Registry):
        if 'Registry' in events:
            events['Registry']['Command'].append(registry_pb2.RegistryKind.Name(event.kind))            
            events['Registry']['Path'].append(event.path)
            events['Registry']['Procid'].append(event.procid)
            events['Registry']['Pid'].append(event.pid) 
        else:
            events['Registry'] = {}
            events['Registry']['Command'] = [registry_pb2.RegistryKind.Name(event.kind)]     
            events['Registry']['Path'] = [event.path]    
            events['Registry']['Procid'] = [event.procid]   
            events['Registry']['Pid'] = [event.pid]   

    if isinstance(event,suspicious_pb2.Suspicious):
        if 'Suspicious' in events:
            events['Suspicious']['Event'].append(suspicious_pb2.SuspiciousEvent.Name(event.event))
            events['Suspicious']['Procid'].append(event.procid)
            events['Suspicious']['Pid'].append(event.pid) 
        else:
            events['Suspicious'] = {}
            events['Suspicious']['Event'] = [suspicious_pb2.SuspiciousEvent.Name(event.event)]  
            events['Suspicious']['Procid'] = [event.procid]   
            events['Suspicious']['Pid'] = [event.pid]  
    if isinstance(event,notification_pb2.Notification):
        if 'Notification' in events:
            events['Notification']['Event'].append(notification_pb2.NotificationType.Name(event.type))
        else:
            events['Notification'] = {}
            events['Notification']['Event'] = [notification_pb2.NotificationType.Name(event.type)]
    if isinstance(event,inject_pb2.Inject):
        if 'Inject' in events:
            events['Inject']['Technique'].append(inject_pb2.Technique.Name(event.technique))
            events['Inject']['Srcprocid'].append(event.srcprocid)
            events['Inject']['Srcpid'].append(event.srcpid) 
            events['Inject']['Dstprocid'].append(event.dstprocid)
            events['Inject']['Dstpid'].append(event.dstpid) 
        else:
            events['Inject']= {}
            events['Inject']['Technique'] = [inject_pb2.Technique.Name(event.technique)]
            events['Inject']['Srcprocid'] = event.srcprocid
            events['Inject']['Srcpid'] = event.srcpid
            events['Inject']['Dstprocid'] = event.dstprocid
            events['Inject']['Dstpid'] = event.dstpid
    if isinstance(event,file_pb2.File):
        if 'File' in events:
            events['File']['Event'].append(file_pb2.FileAccess.Name(event.kind))
            events['File']['Path'].append(event.srcpath)
            events['File']['Procid'].append(event.procid)
            events['File']['Pid'].append(event.pid) 
        else:
            events['File'] = {}
            events['File']['Event'] = [file_pb2.FileAccess.Name(event.kind)]  
            events['File']['Path'] = [event.srcpath]
            events['File']['Procid'] = [event.procid]   
            events['File']['Pid'] = [event.pid]  
    if isinstance(event,mutant_pb2.Mutant):
        if 'Mutant' in events:
            events['Mutant']['Action'].append(mutant_pb2.EventAction.Name(event.action))
            events['Mutant']['Path'].append(event.path)
            events['Mutant']['Procid'].append(event.procid)
            events['Mutant']['Pid'].append(event.pid) 
        else:
            events['Mutant'] = {}
            events['Mutant']['Action'] = [mutant_pb2.EventAction.Name(event.action)]  
            events['Mutant']['Path'] = [event.path]
            events['Mutant']['Procid'] = [event.procid]   
            events['Mutant']['Pid'] = [event.pid]  
    if isinstance(event,thread_pb2.ThreadContext):
        if 'Thread' in events:
            events['Thread']['Action'].append(event.action)
            events['Thread']['Path'].append(event.path)
            events['Thread']['Srcprocid'].append(event.srcprocid)
            events['Thread']['Srcpid'].append(event.srcpid) 
            events['Thread']['Dstprocid'].append(event.dstprocid)
            events['Thread']['Dstpid'].append(event.dstpid) 
        else:
            events['Thread'] = {}
            events['Thread']['Action'] = [event.action]  
            events['Thread']['Path'] = [event.path]
            events['Thread']['Srcprocid'] = event.srcprocid
            events['Thread']['Srcpid'] = event.srcpid
            events['Thread']['Dstprocid'] = event.dstprocid
            events['Thread']['Dstpid'] = event.dstpid
    if isinstance(event,network_pb2.NetworkFlow):
        if 'Network' in events:
            events['Network']['Srcport'].append(event.srcport)
            events['Network']['Dstport'].append(event.dstport)
            events['Network']['Srcip'].append(socket.inet_ntoa(struct.pack("!I", event.srcip)))
            events['Network']['Dstip'].append(socket.inet_ntoa(struct.pack("!I", event.dstip)))
        else:
            events['Network'] = {}
            events['Network']['Srcport'] = [event.srcport]  
            events['Network']['Dstport'] = [event.dstport] 
            events['Network']['Srcip'] = [socket.inet_ntoa(struct.pack("!I", event.srcip))]  
            events['Network']['Dstip'] = [socket.inet_ntoa(struct.pack("!I", event.dstip))]  
    if isinstance(event,whois_pb2.Whois):
        if 'Whois' in events:
            events['Whois']['Os'].append(event.os)
            events['Whois']['Build'].append(event.build)
        else:
            events['Whois'] = {}
            events['Whois']['Os'] = [whois_pb2.Architecture.Name(event.os)]  
            events['Whois']['Build'] = [event.build]
    if isinstance(event,vminfo_pb2.Vminfo):
        if 'Vminfo' in events:
            events['Vminfo']['Name'].append(event.computer_name)
            events['Vminfo']['Volume'].append(event.volume_name)
            events['Vminfo']['Serial'].append(event.volume_serial)
        else:
            events['Vminfo'] = {}
            events['Vminfo']['Name'] = [event.computer_name]  
            events['Vminfo']['Volume'] = [event.volume_name]
            events['Vminfo']['Serial'] = [event.volume_serial]
    return events

def jsondump(report, jsonfile):
    with open(jsonfile, 'w') as outfile:
        json.dump(report, outfile)

def last(f, results, flowables, style_sheet):
    currentsig = f
    for k in results[currentsig]:
        flowables.append(Paragraph(f"{k} Events:", style_sheet['BodyText']))
        eventkeys = list(results[currentsig][k].keys())
        keycount = 1
        evencount = 0
        for a in results[currentsig][k]:
            if evencount == len(results[currentsig][k][a]):
                break
            for j in results[currentsig][k][a]:
                re = a + ": " + j
                while keycount < len(eventkeys):
                    re = re + ", " + eventkeys[keycount] + ": " + str(results[currentsig][k][eventkeys[keycount]][evencount])
                    keycount += 1
                evencount += 1
                keycount = 1
                flowables.append(Paragraph(f"{re}", style_sheet['Code']))
    return flowables


def generatepdf(sigsmatched,results,final,pdffile):
    doc = SimpleDocTemplate(pdffile)
    style_sheet = getSampleStyleSheet()

    flowables = []

    img = Image("cuckoo.png",width=180, height=60)
    img.hAlign = "RIGHT"

    paragraph_1 = Paragraph("Sample Report", style_sheet['Heading1'])

    style_sheet.add(ParagraphStyle(name='mystyle',
                            fontFamily='Helvetica-Bold',
                            fontSize=16,
                            textColor=colors.HexColor("#DE0909")))

    paragraph_2 = Paragraph(f"{sigsmatched} signatures were triggered", style_sheet['mystyle'])

    flowables.append(img)
    flowables.append(paragraph_1)
    flowables.append(paragraph_2)

    i = 0
    sigcount = 1
    for arr in final:
        for f in arr:
            #if len(results) == sigcount and f == final[-1][3]:
            if i % 4 == 0 and f != "" or i == 0:
                if i != 0:
                    for k in results[currentsig]:
                        flowables.append(Paragraph(f"{k} Events:", style_sheet['BodyText']))
                        eventkeys = list(results[currentsig][k].keys())
                        keycount = 1
                        evencount = 0
                        for a in results[currentsig][k]:
                            if evencount == len(results[currentsig][k][a]):
                                break
                            for j in results[currentsig][k][a]:
                                re = a + ": " + j
                                while keycount < len(eventkeys):
                                    re = re + ", " + eventkeys[keycount] + ": " + str(results[currentsig][k][eventkeys[keycount]][evencount])
                                    keycount += 1
                                evencount += 1
                                keycount = 1
                                flowables.append(Paragraph(f"{re}", style_sheet['Code']))

                flowables.append(Paragraph(f"{sigcount}. {f}", style_sheet['Heading2']))
                currentsig = f
                i+=1
                sigcount+=1
                continue
            if f == "":
                i+=1
                continue
            if f == "None":
                flowables.append(Paragraph(f"The signature does not match any TTP Number", style_sheet['BodyText']))
                i+=1
                continue
            else:
                rep = f.replace("\n","")
                flowables.append(Paragraph(f"{rep}", style_sheet['BodyText']))
                i+=1
                if f == final[-1][3]:
                    f = final[-1][0]
                    flowables = last(f, results, flowables, style_sheet)
                    
            
    doc.build(flowables)

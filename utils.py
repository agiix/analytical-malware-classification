
import os.path
from importlib import import_module

def enumerate_plugins(package_path, namespace, class_, attributes={}):

    """Import plugins of type `class` located at `dirpath` into the
    `namespace` that starts with `module_prefix`. If `dirpath` represents a
    filepath then it is converted into its containing directory. The
    `attributes` dictionary allows one to set extra fields for all imported
    plugins. Using `as_dict` a dictionary based on the module name is
    returned."""

    try:
        dirpath = import_module(package_path).__file__
    except ImportError as e:
        raise ImportError(
            f"Unable to import plugins from package path: {package_path}. {e}"
        )
    if os.path.isfile(dirpath):
        dirpath = os.path.dirname(dirpath)

    for fname in os.listdir(dirpath):
        if fname.endswith(".py") and not fname.startswith("__init__"):
            module_name, _ = os.path.splitext(fname)
            try:
                import_module(f"{package_path}.{module_name}")
            except ImportError as e:
                raise ImportError(
                    "Unable to load the Cuckoo plugin at %s: %s. Please "
                    "review its contents and/or validity!" % (fname, e)
                )

    subclasses = class_.__subclasses__()[:]

    plugins = []
    while subclasses:
        subclass = subclasses.pop(0)

        # Include subclasses of this subclass (there are some subclasses, e.g.,
        # Libvirt machineries such as KVM. KVM<-Libvirt<-Machinery
        subclasses.extend(subclass.__subclasses__())

        # Check whether this subclass belongs to the module namespace that
        # we are currently importing. It should be noted that parent and child
        # namespaces should fail the following if-statement.
        if package_path != ".".join(subclass.__module__.split(".")[:-1]):
            continue

        namespace[subclass.__name__] = subclass
        for key, value in attributes.items():
            setattr(subclass, key, value)

        plugins.append(subclass)

    return sorted(plugins, key=lambda x: x.__name__.lower())

# Copyright (C) 2020 Cuckoo Foundation.
# This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org
# See the file 'docs/LICENSE' for copying permission.

from google.protobuf import message

from . import (
    file_pb2, inject_pb2, mutant_pb2, network_pb2, notification_pb2,
    process_pb2, registry_pb2, suspicious_pb2, thread_pb2, vminfo_pb2,
    whois_pb2
)

class EventTypes:
    PROCESS = 1
    REGISTRY = 2
    SUSPICIOUS = 3
    NOTIFICATION = 5
    INJECT = 6
    FILE = 8
    MUTANT = 9
    THREAD = 10
    NETWORK = 12
    WHOIS = 14
    VMINFO = 15


_kindmap = {
    1: process_pb2.Process,
    2: registry_pb2.Registry,
    3: suspicious_pb2.Suspicious,
    5: notification_pb2.Notification,
    6: inject_pb2.Inject,
    8: file_pb2.File,
    9: mutant_pb2.Mutant,
    10: thread_pb2.ThreadContext,
    12: network_pb2.NetworkFlow,
    14: whois_pb2.Whois,
    15: vminfo_pb2.Vminfo,
}

def read_events(buffreader):
    while True:
        start_offset = buffreader.tell()
        header = buffreader.read(4)
        if not header:
            buffreader.seek(start_offset)
            break

        if not len(header) == 4:
            buffreader.seek(start_offset)
            break

        data_size = sum(b * (256**i) for i, b in enumerate(header[:3]))
        kind = int(header[3])

        decoder_normalizer = _kindmap.get(kind)
        if not decoder_normalizer:
            print(f"Unsupported event ->>>>>>>>>>>>>> {kind}")
            # Unsupported event kind. Skip the amount of bytes equal to the
            # event data size. The header bytes are already read.
            buffreader.seek(buffreader.tell() + data_size)
            continue

        data = buffreader.read(data_size)
        if len(data) != data_size:
            buffreader.seek(start_offset)
            break

        kind_instance = decoder_normalizer()

        try:
            kind_instance.ParseFromString(data)
        except message.DecodeError as e:
            print(f"PB decoding error: {e}")
            continue

        yield kind, kind_instance
